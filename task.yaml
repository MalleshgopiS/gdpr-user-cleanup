metadata:
  name: gdpr-user-cleanup
  category: devops
  difficulty: hard
  tags:
    - kubernetes
    - gdpr
    - distributed-systems
    - data-cleanup

description: |
  The Bleater platform fails GDPR audits because deleting a user
  removes credentials only from auth-db while leaving personal data
  across multiple systems.

  Implement a "Right to be Forgotten" cleanup pipeline.

  Target user:
    USER_ID = user123

  System Architecture:

  PostgreSQL (auth-db)
    table users(id TEXT PRIMARY KEY, email TEXT)

  PostgreSQL (bleat-db)
    table posts(id SERIAL, author_id TEXT, content TEXT)

  MongoDB
    database: bleater
    collection: profiles
    document:
      { user_id: <string>, name: <string> }

  Redis
    key format:
      session:<USER_ID>

  MinIO
    bucket: avatars
    object: <USER_ID>.png

requirements:
  - Delete auth-db record
  - Delete MongoDB profile
  - Delete Redis session
  - Delete MinIO avatar
  - Anonymize posts (do NOT delete)
  - Remove all PII references
  - Must be idempotent

success_criteria:
  - User removed from auth-db
  - Mongo profile removed
  - Redis session removed
  - Avatar returns HTTP 404
  - Posts contain no reference to USER_ID
  - Running twice produces identical result