metadata:
  name: gdpr-user-cleanup
  category: devops
  difficulty: hard

description: |
  The Bleater platform fails GDPR audits because deleting a user
  removes credentials only from auth-db while leaving personal data
  across distributed systems.

  Implement a GDPR "Right to be Forgotten" cleanup pipeline.

  Target User:
    USER_ID = user123

  System Architecture:

  PostgreSQL (auth-db)
    users(id TEXT PRIMARY KEY, email TEXT)

  PostgreSQL (bleat-db)
    posts(id SERIAL, author_id TEXT, content TEXT)

  MongoDB
    database: bleater
    collection: profiles
    document:
      { user_id: <string>, name: <string> }

  Redis
    key format:
      session:<USER_ID>

  MinIO
    endpoint: http://minio:9000
    bucket: avatars
    object: <USER_ID>.png
    credentials: minioadmin / minioadmin

requirements:
  - Delete auth-db record
  - Remove Mongo profile
  - Remove Redis session
  - Delete MinIO avatar object
  - Anonymize posts (do NOT delete)
  - Remove ALL references to USER_ID from content
  - Pipeline must be idempotent

success_criteria:
  - Auth record removed
  - Mongo profile removed
  - Redis session removed
  - Avatar returns HTTP 404
  - No post contains USER_ID
  - Running twice produces identical state